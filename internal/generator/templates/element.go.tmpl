// Package elements {{.Namespace.Name}} {{.Element.Name}} is generated from configuration file.
package elements

import (
    "fmt"
    "html"
    "sort"
    "strings"
    "github.com/igrmk/treemap/v2"
)

{{$nsPrefix := .Namespace.Prefix -}}
{{$elName := .Element.Name | goPascal -}}
{{$elStructName := printf "%s%sElement" $nsPrefix $elName -}}
{{$elNoChildren := .Element.NoChildren -}}
{{.Element.Description | comments}}
type {{$elStructName}} struct {
	*Element
}

// Create a new {{$elStructName}} element. This will create a new element
// with the tag "{{.Element.Tag}}" during rendering.
func {{if $nsPrefix}}{{$nsPrefix}}{{end}}{{$elName}}({{if not $elNoChildren}}children ...ElementRenderer{{end}}) *{{$elStructName}} {
	e := NewElement("{{.Element.Tag}}", {{if not $elNoChildren}}children...{{end}})
	e.isSelfClosing = {{$elNoChildren}}
	{{if not $elNoChildren}}e.descendants = children{{end}}
	return &{{$elStructName}}{ Element: e }
}

func (e *{{$elStructName}}) Children(children ...ElementRenderer) *{{$elStructName}} {
	e.descendants = append(e.descendants, children...)
	return e
}

func(e *{{$elStructName}}) IfChildren(condition bool, children ...ElementRenderer) *{{$elStructName}} {
	if condition {
		e.descendants = append(e.descendants, children...)
	}
	return e
}

func(e *{{$elStructName}}) TernChildren(condition bool, trueChildren, falseChildren ElementRenderer) *{{$elStructName}} {
	if condition {
		e.descendants = append(e.descendants, trueChildren)
	} else {
		e.descendants = append(e.descendants, falseChildren)
	}
  return e
}

func (e *{{$elStructName}}) BoolAttr(name string) *{{$elStructName}} {
	if e.boolAttributes == nil {
		e.boolAttributes = treemap.New[string, bool]()
	}
	e.boolAttributes.Set(name, true)
	return e
}

func (e *{{$elStructName}}) IfBoolAttr(condition bool, name string) *{{$elStructName}} {
	if condition {
		e.BoolAttr(name)
	}
	return e
}

func (e *{{$elStructName}}) Attr(name, value string) *{{$elStructName}} {
	if e.stringAttributes == nil {
		e.stringAttributes = treemap.New[string, string]()
	}
	e.stringAttributes.Set(name, value)
	return e
}

func (e *{{$elStructName}}) IfAttr(condition bool, name, value string) *{{$elStructName}} {
	if condition {
		e.Attr(name, value)
	}
	return e
}

func (e *{{$elStructName}}) Text(text string) *{{$elStructName}} {
	e.descendants = append(e.descendants, Text(text))
	return e
}

func (e *{{$elStructName}}) Textf(format string, args ...any) *{{$elStructName}} {
	return e.Text(fmt.Sprintf(format, args...))
}

func (e *{{$elStructName}}) IfText(condition bool, text string) *{{$elStructName}} {
	if condition {
		e.descendants = append(e.descendants, Text(text))
	}
	return e
}

func (e *{{$elStructName}}) IfTextf(condition bool, format string, args ...any) *{{$elStructName}} {
    if condition {
        e.descendants = append(e.descendants, Text(fmt.Sprintf(format, args...)))
    }
    return e
}

func (e *{{$elStructName}}) Escaped(text string) *{{$elStructName}} {
    e.descendants = append(e.descendants, Escaped(text))
    return e
}

func (e *{{$elStructName}}) IfEscaped(condition bool, text string) *{{$elStructName}} {
    if condition {
        e.descendants = append(e.descendants, Escaped(text))
    }
    return e
}

func (e *{{$elStructName}}) Escapedf(format string, args ...any) *{{$elStructName}} {
    return e.Escaped(fmt.Sprintf(format, args...))
}

func (e *{{$elStructName}}) IfEscapedf(condition bool, format string, args ...any) *{{$elStructName}} {
    if condition {
        e.descendants = append(e.descendants, Escapedf(format, args...))
    }
    return e
}

{{range .Element.Attributes}}
    {{if .Type | attrIsString -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}(s string) *{{$elStructName}}{
            if e.stringAttributes == nil {
                e.stringAttributes = treemap.New[string,string]()
            }
            e.stringAttributes.Set("{{.Key}}", s)
            return e
        }

        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}f(format string, args ...any) *{{$elStructName}}{
            return e.{{.Name}}(fmt.Sprintf(format, args...))
        }

        {{.Description | comments}}
        func(e *{{$elStructName}}) If{{.Name}}(condition bool, s string) *{{$elStructName}}{
            if condition {
                e.{{.Name}}(s)
            }
            return e
        }

        {{.Description | comments}}
        func(e *{{$elStructName}}) If{{.Name}}f(condition bool, format string, args ...any) *{{$elStructName}}{
            if condition {
                e.{{.Name}}(fmt.Sprintf(format, args...))
            }
            return e
        }

        {{.Description | comments}}
        // Remove the attribute {{.Name}} from the element.
        func(e *{{$elStructName}}) {{.Name}}Remove() *{{$elStructName}}{
            if e.stringAttributes == nil {
                return e
            }
            e.stringAttributes.Del("{{.Key}}")
            return e
        }


    {{else if .Type | attrIsDelimited -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}(s string) *{{$elStructName}}{
            values := strings.Split(s, "{{.Type.Delimiter}}")
            if e.delimitedStrings == nil {
                e.delimitedStrings = treemap.New[string, *delimitedBuilder[string]]()
            }
            ds, ok := e.delimitedStrings.Get("{{.Key}}")
            if !ok {
                ds = newDelimitedBuilder[string]("{{.Type.Delimiter}}")
                e.delimitedStrings.Set("{{.Key}}", ds)
            }
            ds.Add(values...)
            return e
        }

        {{.Description | comments}}
        func(e *{{$elStructName}}) If{{.Name}}(condition bool, s string) *{{$elStructName}}{
            if condition {
                e.{{.Name}}(s)
            }
            return e
        }

        {{.Description | comments}}
        // Remove the values from the attribute {{.Name}} in the element.
        func(e *{{$elStructName}}) {{.Name}}Remove(s ...string) *{{$elStructName}}{
            if e.delimitedStrings == nil {
                return e
            }
            ds, ok := e.delimitedStrings.Get("{{.Key}}")
            if !ok {
                return e
            }
            ds.Remove(s...)
            return e
        }

    {{else if .Type | attrIsKV -}}
        {{.Description | comments}}
        func (e *{{$elStructName}}) {{.Name}}Pairs(pairs ...string) *{{$elStructName}} {
            if len(pairs) == 0 || len(pairs)%2 != 0 {
                panic("{{.Name}}Pairs requires an even number of arguments representing key-value pairs.")
            }
            if e.keyValueStrings == nil {
                e.keyValueStrings = treemap.New[string,*keyValueBuilder]()
            }
            kv, ok := e.keyValueStrings.Get("{{.Key}}")
            if !ok {
                kv = newKVBuilder("{{.Type.KeyValueDelimiter}}", "{{.Type.PairDelimiter}}")
                e.keyValueStrings.Set("{{.Key}}", kv)
            }
            for i := 0; i < len(pairs)-1; i += 2 {
                key := strings.TrimSpace(pairs[i])
                if key == "" {
                    panic("empty key in key-value pairs.")
                }
                value := strings.TrimSpace(pairs[i+1])
                kv.Add(key, value)
            }
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) {{.Name}}(s string) *{{$elStructName}} {
            if e.keyValueStrings == nil {
               e.keyValueStrings = treemap.New[string,*keyValueBuilder]()
            }
            _, ok := e.keyValueStrings.Get("{{.Key}}")
            if !ok {
                kv := newKVBuilder("{{.Type.KeyValueDelimiter}}", "{{.Type.PairDelimiter}}")
                e.keyValueStrings.Set("{{.Key}}", kv)
            }
            s = strings.TrimRight(s, "{{.Type.PairDelimiter}}")
            kvPairs := strings.Split(s, "{{.Type.PairDelimiter}}")
            for _, pair := range kvPairs {
                parts := strings.SplitN(pair, "{{.Type.KeyValueDelimiter}}", 2)
                if len(parts) != 2 {
                    panic(fmt.Sprintf("invalid key-value pair: %q", pair))
                }
                e.{{.Name}}Pairs(parts[0], parts[1])
            }
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) If{{.Name}}(condition bool, s string) *{{$elStructName}} {
            if condition {
                e.{{.Name}}(s)
            }
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) {{.Name}}Add(k string, v string) *{{$elStructName}} {
            if e.keyValueStrings == nil {
                e.keyValueStrings = treemap.New[string,*keyValueBuilder]()
            }
            _, ok := e.keyValueStrings.Get("{{.Key}}")
            if !ok {
                kv := newKVBuilder("{{.Type.KeyValueDelimiter}}", "{{.Type.PairDelimiter}}")
                e.keyValueStrings.Set("{{.Key}}", kv)
            }
            e.{{.Name}}Pairs(k, v)
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) {{.Name}}Addf(k string, format string, args ...any) *{{$elStructName}} {
            return e.{{.Name}}Add(k, fmt.Sprintf(format, args...))
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) If{{.Name}}Add(condition bool, k string, v string) *{{$elStructName}} {
            if condition {
                e.{{.Name}}Add(k, v)
            }
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) If{{.Name}}Addf(condition bool, k string, format string, args ...any) *{{$elStructName}} {
            if condition {
                e.{{.Name}}Addf(k, format, args...)
            }
            return e
        }

        {{.Description | comments}}
        // Add the attributes in the map to the element.
        func (e *{{$elStructName}}) {{.Name}}Map(m map[string]string) *{{$elStructName}} {
            if e.keyValueStrings == nil {
                e.keyValueStrings = treemap.New[string,*keyValueBuilder]()
            }
            _, ok := e.keyValueStrings.Get("{{.Key}}")
            if !ok {
								kv := newKVBuilder("{{.Type.KeyValueDelimiter}}", "{{.Type.PairDelimiter}}")
                e.keyValueStrings.Set("{{.Key}}", kv)
            }
            keys := make([]string, 0, len(m))
            for k := range m {
                keys = append(keys, k)
            }
            sort.Strings(keys)
            for _, k := range keys {
                e.{{.Name}}Pairs(k, m[k])
            }
            return e
        }


        {{.Description | comments}}
        // Remove the attribute {{.Name}} from the element.
        func (e *{{$elStructName}}) {{.Name}}Remove(keys ...string) *{{$elStructName}} {
            if e.keyValueStrings == nil {
                return e
            }
            kv, ok := e.keyValueStrings.Get("{{.Key}}")
            if !ok {
                return e
            }
            kv.Remove(keys...)
            return e
        }

    {{else if .Type | attrIsChoices -}}
        {{$choicePrefix := (printf "%s%s%s" $nsPrefix $elName (.Key | goPascal)) -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}(c {{$choicePrefix}}Choice) *{{$elStructName}}{
            if e.stringAttributes == nil {
                e.stringAttributes = treemap.New[string,string]()
            }
            e.stringAttributes.Set("{{.Key}}", string(c))
            return e
        }

        type {{$choicePrefix}}Choice string

        const(
				{{$choices := .Type.Choices -}}
        {{range $i, $choice := $choices -}}
						{{$suffix := choiceSuffix $choice.Name $choices -}}
            {{.Description | comments}}
						{{$choicePrefix}}{{$suffix}} {{$choicePrefix}}Choice = "{{.Name}}"
        {{end -}}
        )

        {{.Description | comments}}
        // Remove the attribute {{.Name}} from the element.
        func(e *{{$elStructName}}) {{.Name}}Remove() *{{$elStructName}}{
            if e.stringAttributes == nil {
                return e
            }
            e.stringAttributes.Del("{{.Key}}")
            return e
        }

        {{else if .Type | attrIsInt -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}(i int) *{{$elStructName}}{
            if e.intAttributes == nil {
                e.intAttributes = treemap.New[string,int]()
            }
            e.intAttributes.Set("{{.Key}}", i)
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) If{{.Name}}(condition bool, i int) *{{$elStructName}} {
            if condition {
                e.{{.Name}}(i)
            }
            return e
        }

        {{.Description | comments}}
        // Remove the attribute {{.Name}} from the element.
        func(e *{{$elStructName}}) {{.Name}}Remove() *{{$elStructName}}{
            if e.intAttributes == nil {
                return e
            }
            e.intAttributes.Del("{{.Key}}")
            return e
        }

    {{else if .Type | attrIsNumber -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}(f float64) *{{$elStructName}}{
            if e.floatAttributes == nil {
                e.floatAttributes = treemap.New[string,float64]()
            }
            e.floatAttributes.Set("{{.Key}}", f)
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) If{{.Name}}(condition bool, f float64) *{{$elStructName}} {
            if condition {
                e.{{.Name}}(f)
            }
            return e
        }

    {{else if .Type | attrIsBool -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}() *{{$elStructName}}{
            e.{{.Name}}Set(true)
            return e
        }

        {{.Description | comments}}
        func(e *{{$elStructName}}) If{{.Name}}(condition bool) *{{$elStructName}} {
            if condition {
                e.{{.Name}}Set(true)
            }
            return e
        }

        {{.Description | comments}}
        // Set the attribute {{.Name}} to the value b explicitly.
        func(e *{{$elStructName}}) {{.Name}}Set(b bool) *{{$elStructName}}{
            if e.boolAttributes == nil {
                e.boolAttributes = treemap.New[string,bool]()
            }
            e.boolAttributes.Set("{{.Key}}", b)
            return e
        }

        {{.Description | comments}}
        func (e *{{$elStructName}}) IfSet{{.Name}}(condition bool, b bool) *{{$elStructName}} {
            if condition {
                e.{{.Name}}Set(b)
            }
            return e
        }

        // Remove the attribute {{.Name}} from the element.
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}Remove() *{{$elStructName}}{
            if e.boolAttributes == nil {
                return e
            }
            e.boolAttributes.Del("{{.Key}}")
            return e
        }

    {{else if .Type | attrIsRune -}}
        {{.Description | comments}}
        func(e *{{$elStructName}}) {{.Name}}(r rune) *{{$elStructName}}{
            if e.stringAttributes == nil {
                e.stringAttributes = treemap.New[string,string]()
            }
            e.stringAttributes.Set("{{.Key}}", string(r))
            return e
        }

        {{.Description | comments}}
        func(e *{{$elStructName}}) If{{.Name}}(condition bool, r rune) *{{$elStructName}}{
            if condition {
                e.{{.Name}}(r)
            }
            return e
        }

        {{.Description | comments}}
        // Remove the attribute {{.Name}} from the element.
        func(e *{{$elStructName}}) {{.Name}}Remove() *{{$elStructName}}{
            if e.stringAttributes == nil {
                return e
            }
            e.stringAttributes.Del("{{.Key}}")
            return e
        }

    {{else -}}
        !!!No handler for type {{.Type}}.
    {{end}}
{{end}}
